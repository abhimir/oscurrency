<% if params[:id_provider] %>
  <% content_for(:fbconnect) do %>
    <%= fb_connect_javascript_tag %>
    <%= init_fb_connect "XFBML", :app_settings => "{permsToRequestOnConnect: 'email'}" %>
  <% end %>
<% end %>
<%- column_div :type => :primary do -%>
  <h2><%= t('sessions.new.header') %></h2>

<% unless params[:id_provider] %>
  <% form_tag session_path do -%>
<span id="standard">
    <div class="form_row">
      <label for="email"><%= t('sessions.new.email_address') %></label>
      <%= text_field_tag 'email', params[:email],
                                  :maxlength => Person::MAX_EMAIL  %>
    </div>
    <%= set_focus_to "email" %>

    <div class="form_row">
      <label for="password"><%= t('sessions.new.password') %></label>
      <%= password_field_tag 'password', params[:password],
                                         :maxlength => Person::MAX_PASSWORD %>
    </div>
</span>
    <div class="form_row" id="openid">
      <label for="openid_url"><%= t('sessions.new.openid') %></label>
      <%= text_field_tag "openid_url" %>
    </div>

    <div class="form_row">
      <label for="remember_me" class="checkbox"><%= t('sessions.new.remember_me') %></label>
      <%= check_box_tag 'remember_me', '1', true, :class => "checkbox" %>
    </div>

    <div class="form_row">
      <%= submit_tag t('sessions.new.button_signin'), :class => "button" %>
    </div>
<div class="alt_login">
  <%= link_to t('sessions.new.or_signup'), signup_path %> <br />
  <%- if global_prefs.can_send_email? -%>
    <%= link_to t('sessions.new.i_forgot_my_password'), new_password_reminder_path %> ::
  <%- end -%>
    <span id="noscript" style="display:none;">
      <span id="openid_link"><a href="#" onclick="show_openid(); return false;"><%= t('sessions.new.login_using_openid') %></a></span>
      <span id="standard_link"><a href="#" onclick="show_standard(); return false;"><%= t('sessions.new.back_to_regular_login') %></a></span>
      :: <span id="facebook_link"><a href="#" onclick='window.location="/login?id_provider=facebook"; return false;'>Facebook</a></span>
    </span>

</div>
  <% end -%>
<% else %>
  <div class="alt_login">
    <%= fb_login_button('document.forms["sessionform"].submit();') %>
  </div>
  <% form_tag session_path, :id => 'sessionform' do -%>
    <%= hidden_field_tag 'id_provider', 'facebook' %>
  <% end %>
  <div class="alt_login">
    <a href="/login">Back to Login with Commons Identity</a>
  </div>
<% end %>
<%- end -%>
<script type='text/javascript'>
show_openid = function() {
    $('openid').show();
    $('standard').hide();
    $('openid_link').hide();
    $('standard_link').show();
    createCookie('use_openid', 1, 30);
    $('openid_url').value = 'http://';
}
show_standard = function() {
    $('openid').hide();
    $('standard').show();
    $('openid_link').show();
    $('standard_link').hide();
    eraseCookie('use_openid');
    $('openid_url').value = '';
}
show_facebook = function() {
}
$('openid').hide();
$('standard_link').hide();
$('noscript').show();

if (readCookie('use_openid')){
    show_openid();
}

function createCookie(name,value,days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime()+(days*24*60*60*1000));
        var expires = "; expires="+date.toGMTString();
    }
    else var expires = "";
    document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

function eraseCookie(name) {
    createCookie(name,"",-1);
}
</script>
